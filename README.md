# Plugin Framework

ä¸€ä¸ªåŸºäº TypeScript å’Œ Rollup çš„æ’ä»¶åŒ– Web æ¡†æ¶ï¼Œæ—¨åœ¨æä¾›æ¨¡å—åŒ–æ’ä»¶å¼€å‘å’Œç®¡ç†èƒ½åŠ›ã€‚

## ğŸ“‹ é¡¹ç›®ç®€ä»‹

Plugin Framework æ˜¯ä¸€ä¸ªè½»é‡çº§ã€å¯æ‰©å±•çš„æ’ä»¶åŒ–æ¡†æ¶ï¼Œä¸º Web åº”ç”¨æä¾›å¼ºå¤§çš„æ’ä»¶ç³»ç»Ÿã€‚å®ƒé‡‡ç”¨ TypeScript å¼€å‘ï¼Œä½¿ç”¨ Rollup è¿›è¡Œæ„å»ºï¼Œå¹¶æ”¯æŒç”Ÿæˆæ²¹çŒ´è„šæœ¬ï¼ˆUserscriptï¼‰ã€‚

**æ ¸å¿ƒä¼˜åŠ¿ï¼š**

- **é«˜åº¦æ¨¡å—åŒ–**ï¼šé€šè¿‡æ’ä»¶æœºåˆ¶ï¼Œå°†å¤æ‚åŠŸèƒ½æ‹†åˆ†ä¸ºç‹¬ç«‹æ¨¡å—ï¼Œé™ä½å¼€å‘å¤æ‚åº¦ï¼Œæé«˜ä»£ç å¯ç»´æŠ¤æ€§ã€‚
- **çµæ´»å¯æ‰©å±•**ï¼šæ”¯æŒåŠ¨æ€åŠ è½½å’Œå¸è½½æ’ä»¶ï¼Œæ–¹ä¾¿åŠŸèƒ½è¿­ä»£å’Œå®šåˆ¶åŒ–éœ€æ±‚ã€‚
- **å¼€å‘æ•ˆç‡é«˜**ï¼šæä¾› TypeScript å¼ºç±»å‹æ”¯æŒå’Œå®Œå–„çš„å·¥å…·é“¾ï¼Œæå‡å¼€å‘ä½“éªŒå’Œæ•ˆç‡ã€‚
- **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆ©ç”¨ Rollup è¿›è¡Œé«˜æ•ˆæ‰“åŒ…ï¼Œç¡®ä¿æœ€ç»ˆäº§ç‰©è½»é‡ä¸”é«˜æ€§èƒ½ã€‚
- **è·¨å¹³å°å…¼å®¹**ï¼šä¸ä»…é€‚ç”¨äºå¸¸è§„ Web åº”ç”¨ï¼Œè¿˜èƒ½è½»æ¾æ‰“åŒ…ä¸ºæ²¹çŒ´è„šæœ¬ï¼Œæ‹“å±•åº”ç”¨åœºæ™¯ã€‚

## âœ¨ ä¸»è¦ç‰¹æ€§

- ğŸ”Œ **æ’ä»¶åŒ–æ¶æ„**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œæ”¯æŒæ’ä»¶çš„åŠ¨æ€åŠ è½½å’Œç®¡ç†
- ğŸ“¦ **TypeScript æ”¯æŒ**ï¼šå®Œæ•´çš„ç±»å‹å®šä¹‰ï¼Œæä¾›æ›´å¥½çš„å¼€å‘ä½“éªŒ
- ğŸ› ï¸ **å†…ç½®æ’ä»¶**ï¼šæä¾›å¤šç§å®ç”¨æ’ä»¶ï¼Œå¼€ç®±å³ç”¨
- ğŸ’¾ **æ•°æ®æŒä¹…åŒ–**ï¼šåŸºäº IndexedDB çš„æ•°æ®å­˜å‚¨ç³»ç»Ÿ
- ğŸ“ **æ—¥å¿—ç³»ç»Ÿ**ï¼šå®Œå–„çš„æ—¥å¿—è®°å½•å’Œè°ƒè¯•åŠŸèƒ½
- ğŸ¯ **æ²¹çŒ´è„šæœ¬**ï¼šæ”¯æŒç”Ÿæˆ Tampermonkey å…¼å®¹çš„ç”¨æˆ·è„šæœ¬
- âš¡ **é«˜æ€§èƒ½æ„å»º**ï¼šä½¿ç”¨ Rollup ä¼˜åŒ–æ‰“åŒ…ä½“ç§¯å’Œæ€§èƒ½
- ğŸ”” **äº‹ä»¶ç³»ç»Ÿ**ï¼šçµæ´»çš„äº‹ä»¶å‘å¸ƒ/è®¢é˜…æœºåˆ¶ï¼Œæ”¯æŒæ’ä»¶é—´é€šä¿¡

## ğŸ—ï¸ é¡¹ç›®ç»“æ„

```
pluginFramework/
â”œâ”€â”€ src/                    # æºä»£ç ç›®å½•
â”‚   â”œâ”€â”€ index.ts           # æ¡†æ¶å…¥å£æ–‡ä»¶
â”‚   â”œâ”€â”€ plugin/            # æ’ä»¶ç›®å½•
â”‚   â”‚   â”œâ”€â”€ DomPlugin.ts   # DOM ç›‘å¬æ’ä»¶
â”‚   â”‚   â”œâ”€â”€ KeyboardPlugin.ts  # é”®ç›˜äº‹ä»¶æ’ä»¶
â”‚   â”‚   â”œâ”€â”€ MousePlugin.ts     # é¼ æ ‡äº‹ä»¶æ’ä»¶
â”‚   â”‚   â”œâ”€â”€ NetworkPlugin.ts   # ç½‘ç»œè¯·æ±‚æ’ä»¶
â”‚   â”‚   â””â”€â”€ index.ts       # æ’ä»¶å¯¼å‡ºæ–‡ä»¶
â”‚   â”œâ”€â”€ composable/        # å¯ç»„åˆå‡½æ•°ç›®å½•
â”‚   â””â”€â”€ util/              # å·¥å…·ç±»ç›®å½•
â”‚       â”œâ”€â”€ EventBus.ts    # äº‹ä»¶æ€»çº¿
â”‚       â”œâ”€â”€ EventDomObserver.ts # DOM äº‹ä»¶è§‚å¯Ÿè€…
â”‚       â”œâ”€â”€ EventEmitter.ts  # äº‹ä»¶å‘å°„å™¨
â”‚       â”œâ”€â”€ EventKeyboardListener.ts # é”®ç›˜äº‹ä»¶ç›‘å¬å™¨
â”‚       â”œâ”€â”€ EventMouseListener.ts # é¼ æ ‡äº‹ä»¶ç›‘å¬å™¨
â”‚       â”œâ”€â”€ EventTypes.ts  # äº‹ä»¶ç±»å‹å®šä¹‰
â”‚       â”œâ”€â”€ PluginBase.ts  # æ’ä»¶åŸºç±»
â”‚       â”œâ”€â”€ db.ts          # æ•°æ®åº“æ“ä½œ
â”‚       â”œâ”€â”€ installedPlugins.ts  # æ’ä»¶ç®¡ç†
â”‚       â””â”€â”€ logger.ts      # æ—¥å¿—ç³»ç»Ÿ
â”œâ”€â”€ dist/                  # æ„å»ºè¾“å‡ºç›®å½•
â”œâ”€â”€ postBuildConfig.mjs    # æ„å»ºåå¤„ç†é…ç½®
â”œâ”€â”€ postbuild.mjs          # æ„å»ºåå¤„ç†è„šæœ¬
â”œâ”€â”€ rollup.config.js       # Rollup é…ç½®æ–‡ä»¶
â”œâ”€â”€ tsconfig.json          # TypeScript é…ç½®
â””â”€â”€ package.json           # é¡¹ç›®é…ç½®æ–‡ä»¶
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚ä¸å®‰è£…

ç¡®ä¿æ‚¨çš„å¼€å‘ç¯å¢ƒæ»¡è¶³ä»¥ä¸‹è¦æ±‚ï¼š

- Node.js >= 16.0.0
- npm æˆ– pnpm

ç„¶åï¼Œå®‰è£…é¡¹ç›®ä¾èµ–ï¼š

```bash
# ä½¿ç”¨ npm
npm install

# æˆ–ä½¿ç”¨ pnpm
pnpm install
```

### å¼€å‘æ¨¡å¼

```bash
# ç›‘å¬æ–‡ä»¶å˜åŒ–ï¼Œè‡ªåŠ¨é‡æ–°æ„å»º
npm run watch
```

### æ„å»ºé¡¹ç›®

```bash
# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build

# æ„å»ºåè‡ªåŠ¨æ·»åŠ æ²¹çŒ´è„šæœ¬å¤´ä¿¡æ¯
npm run postbuild
```

## ğŸ”Œ å†…ç½®æ’ä»¶

Plugin Framework æä¾›äº†ä¸€ç³»åˆ—å¼€ç®±å³ç”¨çš„å†…ç½®æ’ä»¶ï¼Œå¸®åŠ©æ‚¨å¿«é€Ÿæ„å»ºåŠŸèƒ½ã€‚è¿™äº›æ’ä»¶æ¶µç›–äº†å¸¸è§çš„ Web äº¤äº’å’Œæ•°æ®å¤„ç†åœºæ™¯ï¼š

### 1. NetworkPlugin - ç½‘ç»œè¯·æ±‚æ’ä»¶

- **åŠŸèƒ½**ï¼šæ‹¦æˆªå’Œç›‘å¬æ‰€æœ‰ `fetch` è¯·æ±‚ï¼Œè®°å½•è¯·æ±‚å’Œå“åº”æ•°æ®ã€‚
- **ç”¨é€”**ï¼šæ–¹ä¾¿è°ƒè¯•ç½‘ç»œè¡Œä¸ºï¼Œåˆ†ææ¥å£æ€§èƒ½ï¼Œæˆ–è¿›è¡Œæ•°æ®æŠ“å–ã€‚
- **ç‰¹æ€§**ï¼šæä¾›è¯¦ç»†çš„ç½‘ç»œç»Ÿè®¡ä¿¡æ¯ï¼Œæ”¯æŒè‡ªå®šä¹‰è¯·æ±‚/å“åº”å¤„ç†ã€‚

### 2. DomPlugin - DOM ç›‘å¬æ’ä»¶

- **åŠŸèƒ½**ï¼šåŸºäº `MutationObserver` ç›‘å¬ DOM ç»“æ„å˜åŒ–ï¼Œè·Ÿè¸ªç‰¹å®šå…ƒç´ ã€‚
- **ç”¨é€”**ï¼šé€‚ç”¨äºéœ€è¦ç›‘æ§é¡µé¢å…ƒç´ å¢åˆ æ”¹ã€å†…å®¹å˜åŒ–çš„åœºæ™¯ï¼Œä¾‹å¦‚å•é¡µåº”ç”¨ï¼ˆSPAï¼‰ä¸­çš„åŠ¨æ€å†…å®¹åŠ è½½ã€‚
- **ç‰¹æ€§**ï¼šå¯é…ç½®ç›‘å¬èŒƒå›´å’Œäº‹ä»¶ç±»å‹ï¼Œè®°å½• DOM æ“ä½œå†å²ã€‚

### 3. KeyboardPlugin - é”®ç›˜äº‹ä»¶æ’ä»¶

- **åŠŸèƒ½**ï¼šç›‘å¬å…¨å±€é”®ç›˜æŒ‰é”®äº‹ä»¶ï¼Œæ”¯æŒè‡ªå®šä¹‰å¿«æ·é”®ç»‘å®šã€‚
- **ç”¨é€”**ï¼šå®ç°è‡ªå®šä¹‰é”®ç›˜æ“ä½œã€å¿«æ·åŠŸèƒ½ï¼Œæˆ–è®°å½•ç”¨æˆ·æŒ‰é”®è¡Œä¸ºã€‚
- **ç‰¹æ€§**ï¼šæä¾›æŒ‰é”®ç»Ÿè®¡ä¿¡æ¯ï¼Œæ”¯æŒç»„åˆé”®å’Œä¿®é¥°é”®ã€‚

### 4. MousePlugin - é¼ æ ‡äº‹ä»¶æ’ä»¶

- **åŠŸèƒ½**ï¼šç›‘å¬é¼ æ ‡ç§»åŠ¨ã€ç‚¹å‡»ã€æ»šåŠ¨ç­‰äº‹ä»¶ï¼Œè·Ÿè¸ªé¼ æ ‡ä½ç½®ã€‚
- **ç”¨é€”**ï¼šåˆ†æç”¨æˆ·äº¤äº’æ¨¡å¼ï¼Œå®ç°è‡ªå®šä¹‰é¼ æ ‡æ‰‹åŠ¿ï¼Œæˆ–è®°å½•ç‚¹å‡»çƒ­åŒºã€‚
- **ç‰¹æ€§**ï¼šæä¾›ç‚¹å‡»ç»Ÿè®¡ä¿¡æ¯ï¼Œæ”¯æŒäº‹ä»¶å§”æ‰˜å’Œåæ ‡è®°å½•ã€‚

## ğŸ› ï¸ æ’ä»¶å¼€å‘

### åˆ›å»ºè‡ªå®šä¹‰æ’ä»¶

1. ç»§æ‰¿ `PluginBase` åŸºç±»ï¼š

```typescript
import { PluginBase } from "../util/PluginBase";
import { info } from "../util/logger";

export class MyPlugin extends PluginBase {
  constructor() {
    super("myPlugin", "æˆ‘çš„è‡ªå®šä¹‰æ’ä»¶", true, true, ["custom"]);
  }

  async init(): Promise<void> {
    info(`åˆå§‹åŒ– ${this.name} æ’ä»¶`);

    // ä»æ•°æ®åº“åŠ è½½æ•°æ®
    const db = await import("../util/db");
    const savedData = await db.getPluginData(this.name);
    if (savedData) {
      this.databaseData = savedData;
    }

    // åˆå§‹åŒ–æ’ä»¶é€»è¾‘
    this.setupPlugin();
  }

  private setupPlugin(): void {
    // æ’ä»¶å…·ä½“å®ç°
  }
}
```

2. åœ¨ `src/plugin/index.ts` ä¸­æ³¨å†Œæ’ä»¶ï¼š

```typescript
import { MyPlugin } from "./MyPlugin";

export const pluginClasses = [
  // ... å…¶ä»–æ’ä»¶
  MyPlugin,
];
```

### æ’ä»¶åŸºç±» API

- `name`: æ’ä»¶åç§°
- `describe`: æ’ä»¶æè¿°
- `enable`: æ˜¯å¦å¯ç”¨
- `canDisable`: æ˜¯å¦å¯ç¦ç”¨
- `tags`: æ’ä»¶æ ‡ç­¾
- `internalData`: å†…å­˜æ•°æ®ï¼ˆä¸æŒä¹…åŒ–ï¼‰
- `databaseData`: æŒä¹…åŒ–æ•°æ®
- `saveData()`: ä¿å­˜æ•°æ®åˆ° IndexedDB
- `getPlugin<T>(name)`: è·å–å…¶ä»–æ’ä»¶å®ä¾‹
- `emit(eventType, payload)`: è§¦å‘äº‹ä»¶
- `on(eventType, handler)`: ç›‘å¬äº‹ä»¶
- `off(eventType, handler)`: å–æ¶ˆç›‘å¬äº‹ä»¶

## ğŸ“Š æ•°æ®å­˜å‚¨

æ¡†æ¶ä½¿ç”¨ IndexedDB è¿›è¡Œæ•°æ®æŒä¹…åŒ–ï¼š

```typescript
// ä¿å­˜æ’ä»¶æ•°æ®
await this.saveData();

// è·å–æ’ä»¶æ•°æ®
const db = await import("../util/db");
const data = await db.getPluginData("pluginName");

// è·å–æ‰€æœ‰æ’ä»¶æ•°æ®
const allData = await db.getAllPluginData();
```

## ğŸ“ æ—¥å¿—ç³»ç»Ÿ

æ¡†æ¶æä¾›å®Œå–„çš„æ—¥å¿—ç³»ç»Ÿï¼š

```typescript
import { debug, info, warn, error, fatal } from "../util/logger";

debug("è°ƒè¯•ä¿¡æ¯");
info("æ™®é€šä¿¡æ¯");
warn("è­¦å‘Šä¿¡æ¯");
error("é”™è¯¯ä¿¡æ¯");
fatal("è‡´å‘½é”™è¯¯");

// åˆ›å»ºå­ Logger
import { createLogger } from "../util/logger";
const moduleLogger = createLogger({ prefix: "MyModule" });
```

## ğŸ¯ æ²¹çŒ´è„šæœ¬é…ç½®

åœ¨ `postBuildConfig.mjs` ä¸­é…ç½®æ²¹çŒ´è„šæœ¬ä¿¡æ¯ï¼š

```javascript
export default {
  userscript: {
    name: "Plugin Framework Userscript",
    namespace: "http://tampermonkey.net/",
    version: () => "1.0.0",
    description: "åŸºäºTypeScriptå’ŒRollupçš„æ’ä»¶åŒ–Webæ¡†æ¶",
    author: "Your Name",
    match: ["http://*/*", "https://*/*"],
    grant: ["none"],
  },
};
```

## ğŸ”§ é…ç½®è¯´æ˜

### TypeScript é…ç½® (tsconfig.json)

- ç›®æ ‡ç‰ˆæœ¬ï¼šES2017
- æ¨¡å—ç³»ç»Ÿï¼šESNext
- ä¸¥æ ¼æ¨¡å¼ï¼šå¯ç”¨

### Rollup é…ç½® (rollup.config.js)

- è¾“å‡ºæ ¼å¼ï¼šIIFE
- æ”¯æŒ TypeScript
- ä»£ç å‹ç¼©å’Œ Source Map

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ [MIT License](LICENSE) è®¸å¯è¯ã€‚

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Fork æœ¬ä»“åº“
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. å¼€å¯ Pull Request

## ğŸ“ æ”¯æŒä¸åé¦ˆ

å¦‚æœæ‚¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜æˆ–æœ‰æ”¹è¿›å»ºè®®ï¼Œè¯·ï¼š

1. æŸ¥çœ‹ [Issues](../../issues) é¡µé¢
2. åˆ›å»ºæ–°çš„ Issue æè¿°é—®é¢˜
3. å‚ä¸è®¨è®ºå’Œæ”¹è¿›

---

**Happy Coding! ğŸ‰**
